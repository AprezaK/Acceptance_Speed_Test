<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Referral Acceptance Speed Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    .pulse { animation: pulse 0.6s ease-out; }
    @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.04);}100%{transform:scale(1);} }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold tracking-tight">Referral Acceptance Speed Test</h1>
      <p class="text-slate-500">3-minute simulation. Referrals appear randomly. Click <span class="font-semibold">Accept</span> as fast as you can. Each referral expires after 2 seconds.</p>
    </header>
    <section class="grid sm:grid-cols-3 gap-4 mb-4">
      <div class="bg-white/70 dark:bg-slate-800 rounded-2xl shadow p-4">
        <div class="text-sm text-slate-500">Time Left</div>
        <div id="timeLeft" class="text-3xl font-semibold tabular-nums">03:00</div>
      </div>
      <div class="bg-white/70 dark:bg-slate-800 rounded-2xl shadow p-4">
        <div class="text-sm text-slate-500">Shown • Accepted • Missed</div>
        <div class="text-3xl font-semibold tabular-nums"><span id="shown">0</span> • <span id="accepted">0</span> • <span id="missed">0</span></div>
      </div>
      <div class="bg-white/70 dark:bg-slate-800 rounded-2xl shadow p-4">
        <div class="text-sm text-slate-500">Avg Reaction (ms)</div>
        <div id="avgRt" class="text-3xl font-semibold tabular-nums">—</div>
      </div>
    </section>
    <section class="flex flex-wrap gap-3 mb-6">
      <button id="startBtn" class="px-5 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-medium shadow">Start Test</button>
      <button id="stopBtn" class="px-5 py-3 rounded-2xl bg-rose-600 hover:bg-rose-700 text-white font-medium shadow disabled:opacity-50" disabled>End Now</button>
    </section>
    <main id="arena" class="relative min-h-[320px] sm:min-h-[380px] bg-white/70 dark:bg-slate-800 rounded-3xl shadow-inner p-6 flex items-center justify-center overflow-hidden">
      <div id="placeholder" class="text-center text-slate-500">
        <p class="mb-2">When the test starts, referrals will pop up here.</p>
        <p class="text-sm">Click <span class="font-semibold">Accept</span> as quickly as possible. Each referral disappears after <span class="font-semibold">2s</span>.</p>
      </div>
      <div id="referralContainer" class="absolute inset-0 grid place-items-center pointer-events-none"></div>
    </main>
    <section id="resultsSection" class="hidden mt-8">
      <h2 class="text-2xl font-semibold mb-3">Results</h2>
      <div class="grid sm:grid-cols-2 gap-4 mb-4">
        <div class="bg-white/70 dark:bg-slate-800 rounded-2xl shadow p-4">
          <div class="text-sm text-slate-500">Score</div>
          <div id="score" class="text-3xl font-semibold tabular-nums">0</div>
        </div>
        <div class="bg-white/70 dark:bg-slate-800 rounded-2xl shadow p-4">
          <div class="text-sm text-slate-500">Accepts per Minute</div>
          <div id="apm" class="text-3xl font-semibold tabular-nums">0</div>
        </div>
      </div>
      <button id="downloadBtn" class="px-5 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 font-medium">Download Test Results (CSV)</button>
      <button id="restartBtn" class="px-5 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-medium shadow">Run Again</button>
    </section>
  </div>

  <template id="referralTemplate">
    <div class="pointer-events-auto w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200/70 dark:border-slate-700 p-5 pulse">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-xs uppercase tracking-wider text-slate-500">Incoming Referral</div>
          <div class="text-sm text-slate-500">Referral Type: <span data-field="service">PRS/HS</span></div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-500">Expires in</div>
          <div class="text-xl font-semibold tabular-nums" data-field="expires">2.0s</div>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button class="acceptBtn px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium">Accept</button>
      </div>
    </div>
  </template>

  <script>
    const TEST_DURATION_MS = 3 * 60 * 1000;
    const EXPIRE_MS = 2000;
    const APPEAR_INTERVALS = [100, 200, 500, 1000, 1500];
    let running=false, startTime, endTime, timerInterval, currentReferral=null, events=[];
    const startBtn=document.getElementById('startBtn'), stopBtn=document.getElementById('stopBtn'),
          arena=document.getElementById('arena'), placeholder=document.getElementById('placeholder'),
          referralContainer=document.getElementById('referralContainer'), timeLeftEl=document.getElementById('timeLeft'),
          shownEl=document.getElementById('shown'), acceptedEl=document.getElementById('accepted'),
          missedEl=document.getElementById('missed'), avgRtEl=document.getElementById('avgRt'),
          resultsSection=document.getElementById('resultsSection'), scoreEl=document.getElementById('score'),
          apmEl=document.getElementById('apm'), downloadBtn=document.getElementById('downloadBtn'),
          restartBtn=document.getElementById('restartBtn'), referralTemplate=document.getElementById('referralTemplate');

    function randChoice(arr){return arr[Math.floor(Math.random()*arr.length)];}
    function fmtTime(ms){const s=Math.ceil(ms/1000);const mm=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return mm+':'+ss;}
    function updateStats(){
      const shown=events.length;
      const accepted=events.filter(e=>e.outcome!==4).length;
      const missed=events.filter(e=>e.outcome===4).length;
      shownEl.textContent=shown;acceptedEl.textContent=accepted;missedEl.textContent=missed;
      const rts=events.filter(e=>e.reactionMs).map(e=>e.reactionMs);
      avgRtEl.textContent=rts.length?Math.round(rts.reduce((a,b)=>a+b)/rts.length):'—';
    }
    function clearReferral(){if(!currentReferral)return;clearTimeout(currentReferral.timeout);currentReferral.node.remove();currentReferral=null;}
    function spawnReferral(){
      if(!running)return;
      if(currentReferral){events[events.length-1].outcome=4;updateStats();clearReferral();}
      const id=events.length+1;const appearedAt=performance.now();
      const tpl=referralTemplate.content.cloneNode(true);
      const expiresEl=tpl.querySelector('[data-field="expires"]');
      const acceptBtn=tpl.querySelector('.acceptBtn');
      referralContainer.appendChild(tpl);
      const node=referralContainer.lastElementChild;
      const rect=arena.getBoundingClientRect();
      node.style.position='absolute';
      node.style.left=Math.max(20, Math.min(randChoice([20, rect.width-340]), rect.width-340))+'px';
      node.style.top=Math.max(20, Math.min(randChoice([20, rect.height-160]), rect.height-160))+'px';
      placeholder.classList.add('hidden');
      const expireAt=appearedAt+EXPIRE_MS;
      const ev={id,appearedAt,clickedAt:null,reactionMs:null,outcome:4};
      events.push(ev);updateStats();
      const interval=setInterval(()=>{
        const left=Math.max(0,expireAt-performance.now());
        expiresEl.textContent=(left/1000).toFixed(1)+'s';
      },100);
      const timeout=setTimeout(()=>{
        if(!running)return;
        ev.outcome=4;updateStats();clearReferral();clearInterval(interval);nextReferral();
      },EXPIRE_MS);
      acceptBtn.addEventListener('click',()=>{
        if(!running)return;
        const t=performance.now();ev.clickedAt=t;ev.reactionMs=Math.round(t-appearedAt);
        if(ev.reactionMs<=500)ev.outcome=1;
        else if(ev.reactionMs<=1000)ev.outcome=2;
        else if(ev.reactionMs<=2000)ev.outcome=3;
        else ev.outcome=4;
        updateStats();clearInterval(interval);clearReferral();clearTimeout(timeout);nextReferral();
      });
      currentReferral={node,timeout};
    }
    function nextReferral(){if(!running)return;setTimeout(spawnReferral,randChoice(APPEAR_INTERVALS));}
    function startTest(){
      if(running)return;running=true;events=[];updateStats();
      resultsSection.classList.add('hidden');placeholder.classList.remove('hidden');
      clearReferral();startTime=performance.now();endTime=startTime+TEST_DURATION_MS;
      startBtn.disabled=true;stopBtn.disabled=false;updateTimer();
      timerInterval=setInterval(updateTimer,100);spawnReferral();
    }
    function updateTimer(){const left=endTime-performance.now();timeLeftEl.textContent=fmtTime(Math.max(0,left));if(left<=0)finishTest();}
    function finishTest(){
      if(!running)return;running=false;clearInterval(timerInterval);
      startBtn.disabled=false;stopBtn.disabled=true;clearReferral();
      const c1=events.filter(e=>e.outcome===1).length,c2=events.filter(e=>e.outcome===2).length,c3=events.filter(e=>e.outcome===3).length;
      const score=c1*1.5+c2*1+c3*0.5;
      const apm=((c1+c2+c3)/(TEST_DURATION_MS/60000)).toFixed(1);
      scoreEl.textContent=score.toFixed(1);apmEl.textContent=apm;
      resultsSection.classList.remove('hidden');
    }
    startBtn.onclick=startTest;stopBtn.onclick=()=>finishTest();restartBtn.onclick=startTest;
    downloadBtn.onclick=()=>{
      const rows=['Referral #','Reaction','Reaction (ms)'].join(',')+'\n'+events.map((e,i)=>[i+1,e.outcome,e.reactionMs||''].join(',')).join('\n');
      const blob=new Blob([rows],{type:'text/csv'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');
      a.href=url;a.download='Test Results.csv';a.click();URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
